<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get-Homepage CSS GUI Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a202c; color: #e2e8f0; }
        .control-panel, .input-group { background-color: #2d3748; }
        .btn { transition: background-color 0.2s; }
        .btn-primary { background-color: #4299e1; }
        .btn-primary:hover { background-color: #3182ce; }
        .btn-secondary { background-color: #667eea; }
        .btn-secondary:hover { background-color: #5a67d8; }
        input[type="text"], input[type="number"], input[type="range"] { background-color: #4a5568; }
        select {
            background-color: #4a5568;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23e2e8f0' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        input[type="color"] { min-height: 2.5rem; }
        .accordion-header { background-color: #4a5568; cursor: pointer; }
        .accordion-header:hover { background-color: #718096; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .notification {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 1rem 2rem; border-radius: 0.5rem; color: white; z-index: 50;
            opacity: 0; transition: opacity 0.5s ease-in-out;
        }
        .notification.show { opacity: 1; }
        .notification.success { background-color: #38a169; }
        .notification.error { background-color: #c53030; }
        .view-toggle { background-color: #4a5568; }
        .view-toggle:hover { background-color: #718096; }
        .view-toggle.active { background-color: #4299e1; color: white; }
        .resize-handle { cursor: col-resize; width: 10px; }
        @media (max-width: 768px) { .resize-handle { display: none; } }
    </style>
    <style>
        .nav-link {
            @apply px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white;
        }
        .nav-link.active {
            color: #ffffff;
            font-weight: 700;
            border-bottom: 3px solid #3b82f6; /* blue-500 */
        }
    </style>
</head>

<body class="h-screen flex flex-col">
    <header class="bg-gray-800 shadow-md">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-white">Homepage Tool-Box</h1>
                    </div>
                    <div class="hidden md:block" id="desktop-menu">
                        <div class="ml-10 flex items-center space-x-4">
                            {% if any_source_configured %}
                            <a href="/" class="nav-link">Media Manager</a>
                            {% endif %}
                            {% if enable_config_editor %}
                            <a href="/editor" class="nav-link">Config Editor</a>
                            {% endif %}
                            <a href="/editor/css-gui" class="nav-link active">CSS GUI</a>
                            {% if any_source_configured %}
                            <a href="/editor/mappings" class="nav-link">Mappings</a>
                            {% if enable_debug %}
                            <a href="/editor/debug-raw" class="nav-link">Raw Data</a>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% if not any_source_configured %}
                <div class="hidden md:flex items-center space-x-4">
                    <a href="https://ko-fi.com/10mfox" target="_blank" rel="noopener noreferrer" class="text-sm text-pink-400 hover:text-pink-300">❤️ Support Me</a>
                    <div id="app-version" class="text-sm text-gray-400"></div>
                </div>
                {% endif %}
                <div class="-mr-2 flex md:hidden">
                    <!-- Mobile menu button -->
                    <button type="button" id="mobile-menu-button" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
            <!-- Mobile menu, show/hide based on menu state. -->
            <div class="md:hidden hidden" id="mobile-menu">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    {% if any_source_configured %}
                    <a href="/" class="nav-link block">Media Manager</a>
                    {% endif %}
                    {% if enable_config_editor %}
                    <a href="/editor" class="nav-link block">Config Editor</a>
                    {% endif %}
                    <a href="/editor/css-gui" class="nav-link active block">CSS GUI</a>
                    {% if any_source_configured %}
                    <a href="/editor/mappings" class="nav-link block">Mappings</a>
                    {% if enable_debug %}
                    <a href="/editor/debug-raw" class="nav-link block">Raw Data</a>
                    {% endif %}
                    {% endif %}
                </div>
                {% if not any_source_configured %}
                <div class="md:hidden pt-4 pb-3 border-t border-gray-700">
                    <div class="flex items-center px-5 space-x-4">
                        <a href="https://ko-fi.com/10mfox" target="_blank" rel="noopener noreferrer" class="text-sm text-pink-400 hover:text-pink-300">❤️ Support Me</a>
                        <div id="app-version-mobile" class="text-sm text-gray-400"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </nav>
    </header>

    <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
        <!-- Control Panel -->
        <div class="w-full md:w-1/3 p-4 overflow-y-auto">
            <div class="control-panel p-4 rounded-lg shadow-lg">
                <div class="flex justify-between mb-4">
                    <button id="reset-button" class="btn btn-secondary font-bold py-2 px-4 rounded">Reset to Defaults</button>
                    <button id="save-css-button" class="btn btn-primary font-bold py-2 px-4 rounded">Save to custom.css</button>
                </div>
                <!-- Theme Management Section -->
                <div class="input-group p-4 rounded-lg shadow-inner mb-4">
                    <h3 class="text-lg font-semibold mb-2">Theme Management</h3>
                    <div class="flex flex-col space-y-3">
                        <input type="text" id="theme-name-input" placeholder="Enter new theme name..." class="w-full p-2 rounded">
                        <select id="theme-selector" class="w-full p-2 rounded"></select>
                        <div class="flex justify-between space-x-2">
                            <button id="save-theme-button" class="btn btn-primary font-bold py-2 px-4 rounded w-1/3">Save</button>
                            <button id="load-theme-button" class="btn btn-secondary font-bold py-2 px-4 rounded w-1/3">Load</button>
                            <button id="delete-theme-button" class="btn btn-delete bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded w-1/3">Delete</button>
                        </div>
                    </div>
                </div>
                <div id="settings-accordion">
                    <!-- Accordion sections will be injected here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Resize Handle -->
        <div class="resize-handle bg-gray-700 hover:bg-blue-500 transition-colors hidden md:block"></div>

        <!-- Preview Pane -->
        <div class="w-full md:w-2/3 p-4 flex flex-col">
            <div class="input-group p-4 rounded-lg shadow-lg mb-4 flex flex-col space-y-4">
                <div>
                    <label for="homepage-url" class="block font-semibold mb-2">Homepage URL for Preview:</label>
                    <input type="text" id="homepage-url" class="w-full p-2 rounded" placeholder="Set HOMEPAGE_PREVIEW_URL in docker-compose.yml" value="{{ homepage_preview_url }}" {% if homepage_preview_url %}readonly{% endif %}>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Preview Mode:</label>
                    <div id="view-toggle-group" class="flex space-x-2">
                        <button data-view="desktop" class="view-toggle btn font-bold py-2 px-4 rounded active">Desktop</button>
                        <button data-view="mobile-portrait" class="view-toggle btn font-bold py-2 px-4 rounded">Portrait</button>
                        <button data-view="mobile-landscape" class="view-toggle btn font-bold py-2 px-4 rounded">Landscape</button>
                    </div>
                </div>
            </div>
            <div id="preview-viewport" class="flex-grow bg-gray-800 rounded-lg overflow-hidden relative">
                <div id="scaled-wrapper" style="width: 1920px; height: 1080px; transform-origin: 0 0;">
                     <iframe id="preview-frame" style="width: 1920px; height: 1080px;" class="border-0"></iframe>
                </div>
            </div>
        </div>
    </main>

    <div id="notification" class="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const accordionContainer = document.getElementById('settings-accordion');
            const homepageUrlInput = document.getElementById('homepage-url');
            const previewFrame = document.getElementById('preview-frame');
            const saveButton = document.getElementById('save-css-button');
            const resetButton = document.getElementById('reset-button');
            const notification = document.getElementById('notification');
            const previewViewport = document.getElementById('preview-viewport');
            const scaledWrapper = document.getElementById('scaled-wrapper');
            const viewToggleGroup = document.getElementById('view-toggle-group');
            const themeNameInput = document.getElementById('theme-name-input');
            const themeSelector = document.getElementById('theme-selector');
            const saveThemeButton = document.getElementById('save-theme-button');
            const loadThemeButton = document.getElementById('load-theme-button');
            const deleteThemeButton = document.getElementById('delete-theme-button');

            const viewModes = {
                desktop: { width: 1920, height: 1080 },
                'mobile-portrait': { width: 390, height: 844 },
                'mobile-landscape': { width: 844, height: 390 }
            };
            let currentViewMode = 'desktop';

            const THEME_STORAGE_KEY = 'cssGuiThemes';

            // Define the structure of the GUI editor. This is the single source of truth.
            const editorConfig = {
                'Global Styles': {
                    'page_wrapper_bg': { label: 'Page Background', type: 'color', default: '#464ab4', selector: '#page_wrapper', property: 'background-color' },
                    'page_wrapper_color': { label: 'Page Text Color', type: 'color', default: '#ffffff', selector: '#page_wrapper', property: 'color', important: true },
                },
                'Tabs': {
                    'tabs_bg': { label: 'Background', type: 'color', default: '#fa0000', selector: 'button[id$="-tab"]', property: 'background-color', important: true },
                    'tabs_border_color': { label: 'Border Color', type: 'color', default: '#000000', selector: 'button[id$="-tab"]', property: 'border-color', important: true },
                    'tabs_border_width': { label: 'Border Width', type: 'range', default: 2, min: 0, max: 20, unit: 'px', selector: 'button[id$="-tab"]', property: 'border-width', important: true },
                    'tabs_border_radius': { label: 'Border Radius', type: 'range', default: 20, min: 0, max: 50, unit: 'px', selector: 'button[id$="-tab"]', property: 'border-radius', important: true },
                    'tabs_padding': { label: 'Padding', type: 'range', default: 10, min: 0, max: 50, unit: 'px', selector: 'button[id$="-tab"]', property: 'padding', important: true },
                },
                'Widgets & Search': {
                    'widget_search_bg': { label: 'Background', type: 'color', default: '#fa0000', selector: '.widget-container, .information-widget-search', property: 'background-color', important: true },
                    'widget_search_border_color': { label: 'Border Color', type: 'color', default: '#000000', selector: '.widget-container, .information-widget-search', property: 'border-color', important: true },
                    'widget_search_border_width': { label: 'Border Width', type: 'range', default: 2, min: 0, max: 20, unit: 'px', selector: '.widget-container, .information-widget-search', property: 'border-width', important: true },
                    'widget_search_border_radius': { label: 'Border Radius', type: 'range', default: 20, min: 0, max: 50, unit: 'px', selector: '.widget-container, .information-widget-search', property: 'border-radius', important: true },
                    'widget_search_padding': { label: 'Padding', type: 'range', default: 10, min: 0, max: 50, unit: 'px', selector: '.widget-container, .information-widget-search', property: 'padding', important: true },
                },
                'Service Cards': {
                    'service_card_bg': { label: 'Background', type: 'color', default: '#fa0000', selector: '.service-card', property: 'background-color', important: true },
                    'service_card_border_color': { label: 'Border Color', type: 'color', default: '#000000', selector: '.service-card', property: 'border-color', important: true },
                    'service_card_border_width': { label: 'Border Width', type: 'range', default: 2, min: 0, max: 20, unit: 'px', selector: '.service-card', property: 'border-width', important: true },
                    'service_card_border_radius': { label: 'Border Radius', type: 'range', default: 20, min: 0, max: 50, unit: 'px', selector: '.service-card', property: 'border-radius', important: true },
                    'service_card_padding': { label: 'Padding', type: 'range', default: 10, min: 0, max: 50, unit: 'px', selector: '.service-card', property: 'padding', important: true },
                },
                'Bookmarks': {
                    'bookmark_bg': { label: 'Background', type: 'color', default: '#fa0000', selector: '.bookmark-text, .bookmark-group h2, .bookmark-group .bookmark-section-title', property: 'background-color', important: true },
                    'bookmark_border_color': { label: 'Border Color', type: 'color', default: '#000000', selector: '.bookmark-text, .bookmark-group h2, .bookmark-group .bookmark-section-title', property: 'border-color', important: true },
                    'bookmark_border_width': { label: 'Border Width', type: 'range', default: 2, min: 0, max: 20, unit: 'px', selector: '.bookmark-text, .bookmark-group h2, .bookmark-group .bookmark-section-title', property: 'border-width', important: true },
                    'bookmark_border_radius': { label: 'Border Radius', type: 'range', default: 20, min: 0, max: 50, unit: 'px', selector: '.bookmark-text, .bookmark-group h2, .bookmark-group .bookmark-section-title', property: 'border-radius', important: true },
                    'bookmark_padding': { label: 'Padding', type: 'range', default: 10, min: 0, max: 50, unit: 'px', selector: '.bookmark-text, .bookmark-group h2, .bookmark-group .bookmark-section-title', property: 'padding', important: true },
                }
            };

            const showNotification = (message, isError = false) => {
                notification.textContent = message;
                notification.className = `notification ${isError ? 'error' : 'success'} show`;
                setTimeout(() => { notification.classList.remove('show'); }, 3000);
            };

            const updatePreviewScaling = () => {
                if (!previewViewport.clientWidth || !previewViewport.clientHeight) return;
    
                const mode = viewModes[currentViewMode];
                scaledWrapper.style.width = `${mode.width}px`;
                scaledWrapper.style.height = `${mode.height}px`;
                previewFrame.style.width = `${mode.width}px`;
                previewFrame.style.height = `${mode.height}px`;
    
                // Always scale to fit the width of the preview pane and allow vertical scrolling.
                previewViewport.style.overflowY = 'auto';
                const scale = previewViewport.clientWidth / mode.width;
                const x = 0;
                const y = 0;
    
                scaledWrapper.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
            };

            const generateCss = () => {
                let cssText = '';
                const values = collectCssFromInputs();

                const rules = {};

                // Iterate over sections in the config
                for (const [sectionName, sectionControls] of Object.entries(editorConfig)) {
                    // Find the checkbox for this section
                    const sectionToggle = document.querySelector(`.section-toggle[data-section="${sectionName}"]`);

                    // If the section is disabled via its toggle, skip generating its rules
                    if (!sectionToggle || !sectionToggle.checked) {
                        continue;
                    }

                    // Group properties by selector for this enabled section
                    for (const [key, config] of Object.entries(sectionControls)) {

                        if (!rules[config.selector]) {
                            rules[config.selector] = [];
                        }
                        const value = values[key];
                        const important = config.important ? ' !important' : '';
                        rules[config.selector].push(`  ${config.property}: ${value}${important};`);
                    }
                }

                // Build the CSS string
                for (const [selector, properties] of Object.entries(rules)) {
                    cssText += `${selector} {\n`;
                    cssText += properties.join('\n');
                    cssText += '\n}\n\n';
                }
                return cssText.trim();
            };

            const collectCssFromInputs = () => {
                const updatedVars = {};
                for (const section of Object.values(editorConfig)) {
                    for (const [key, config] of Object.entries(section)) {
                        const input = document.getElementById(`control-${key}`);
                        if (input) {
                            let value = input.value;
                            if (config.unit) {
                                value += config.unit;
                            }
                            updatedVars[key] = value;
                        }
                    }
                }
                return updatedVars;
            };

            const updatePreview = () => {
                if (!previewFrame.contentWindow) return;
                const css = generateCss();
                previewFrame.contentWindow.postMessage({ type: 'update-css', css: css }, '*');
            };

            const handleInputChange = () => {
                updatePreview();
            };

            const createControl = (key, config) => {
                const id = `control-${key}`;
                let controlHtml = `<div class="mb-4">
                    <label for="${id}" class="block text-sm font-medium text-gray-300 mb-1">${config.label}</label>`;

                let initialValue = config.default.toString();
                if (config.type === 'range') {
                    initialValue = parseFloat(initialValue) || config.default;
                }

                switch (config.type) {
                    case 'color':
                        controlHtml += `<div class="flex items-center space-x-2">
                                            <input type="color" id="${id}" value="${initialValue}" class="p-1 h-10 rounded" style="min-width: 4rem;">
                                            <input type="text" id="${id}-text" value="${initialValue}" class="w-full p-2 rounded font-mono text-sm">
                                        </div>`;
                        break;
                    case 'range':
                        controlHtml += `<div class="flex items-center space-x-2">
                                            <input type="range" id="${id}" value="${initialValue}" min="${config.min || 0}" max="${config.max || 100}" class="w-full">
                                            <span class="text-sm text-gray-400 w-16 text-right">${initialValue}${config.unit || ''}</span>
                                        </div>`;
                        break;
                    case 'number':
                        controlHtml += `<input type="number" id="${id}" value="${initialValue}" min="${config.min || 0}" max="${config.max || 100}" class="w-full p-2 rounded">`;
                        break;
                    case 'text':
                    default:
                        controlHtml += `<input type="text" id="${id}" value="${initialValue}" class="w-full p-2 rounded">`;
                        break;
                }
                controlHtml += `</div>`;
                return controlHtml;
            };

            const buildEditor = () => {
                let editorHtml = '';
                for (const [section, controls] of Object.entries(editorConfig)) {
                    // Use replace to create a machine-friendly name for the data-section attribute
                    const sectionId = section.replace(/\s|&/g, '-');
                    editorHtml += `<div class="mb-2 last:mb-0">
                        <div class="accordion-header p-3 font-semibold rounded-lg flex justify-between items-center">
                            <span class="cursor-pointer flex-grow">${section}</span>
                            <input type="checkbox" class="section-toggle form-checkbox h-5 w-5 text-blue-500 rounded bg-gray-700 border-gray-600 focus:ring-blue-500" data-section="${section}" checked title="Enable/Disable Section">
                        </div>
                        <div class="accordion-content bg-gray-700 p-4 rounded-b-lg">`;

                    for (const [key, config] of Object.entries(controls)) {
                        editorHtml += createControl(key, config);
                    }

                    editorHtml += `</div></div>`;
                }
                accordionContainer.innerHTML = editorHtml;
            };

            // --- Theme Management ---
            const getThemes = () => {
                return JSON.parse(localStorage.getItem(THEME_STORAGE_KEY) || '{}');
            };

            const saveTheme = (name, settings) => {
                const themes = getThemes();
                themes[name] = settings;
                localStorage.setItem(THEME_STORAGE_KEY, JSON.stringify(themes));
            };

            const deleteTheme = (name) => {
                const themes = getThemes();
                delete themes[name];
                localStorage.setItem(THEME_STORAGE_KEY, JSON.stringify(themes));
            };

            const populateThemeSelector = () => {
                const themes = getThemes();
                const themeNames = Object.keys(themes).sort();
                themeSelector.innerHTML = themeNames.map(name => `<option value="${name}">${name}</option>`).join('');
                if (themeNames.length === 0) {
                    themeSelector.innerHTML = '<option disabled>No saved themes</option>';
                }
            };

            const applyTheme = (settings) => {
                // Apply values to controls
                for (const [key, value] of Object.entries(settings.values)) {
                    const input = document.getElementById(`control-${key}`);
                    if (input) {
                        input.value = value;
                        // Manually trigger updates for linked inputs (color text, range display)
                        if (input.type === 'color') {
                            const textInput = document.getElementById(`${input.id}-text`);
                            if (textInput) textInput.value = value;
                        } else if (input.type === 'range') {
                            const display = input.nextElementSibling;
                            const config = Object.values(editorConfig).flatMap(s => Object.entries(s)).find(([k,v]) => k === key)[1];
                            if (display && config) display.textContent = value + (config.unit || '');
                        }
                    }
                }

                // Apply section toggle states
                document.querySelectorAll('.section-toggle').forEach(toggle => {
                    const sectionName = toggle.dataset.section;
                    toggle.checked = settings.sections[sectionName] !== false; // Default to checked if not in settings
                });

                updatePreview();
                showNotification('Theme loaded successfully.');
            };

            const handleSaveTheme = () => {
                const name = themeNameInput.value.trim();
                if (!name) {
                    showNotification('Please enter a name for the theme.', true);
                    return;
                }
                const values = collectCssFromInputs();
                const sections = {};
                document.querySelectorAll('.section-toggle').forEach(toggle => {
                    sections[toggle.dataset.section] = toggle.checked;
                });
                saveTheme(name, { values, sections });
                populateThemeSelector();
                themeSelector.value = name; // Select the newly saved theme
                showNotification(`Theme '${name}' saved.`);
            };

            const resetToDefaults = async () => {
                // 1. Reset the UI controls to their default values
                Object.values(editorConfig).forEach(section => {
                    Object.entries(section).forEach(([key, config]) => {
                        const input = document.getElementById(`control-${key}`);
                        if (input) {
                            if (input.type === 'range') {
                                input.value = parseFloat(config.default) || config.default;
                                input.nextElementSibling.textContent = (parseFloat(config.default) || config.default) + (config.unit || '');
                            } else {
                                input.value = config.default;
                            }
                            if (input.type === 'color') {
                                const textInput = document.getElementById(`${input.id}-text`);
                                if (textInput) textInput.value = config.default;
                            }
                        }
                    });
                });

                // Also reset the section toggles
                document.querySelectorAll('.section-toggle').forEach(toggle => {
                    toggle.checked = true;
                });

                // 2. Update the live preview to show the reset state
                updatePreview();

                // 3. Make an API call to clear the custom.css file
                try {
                    const response = await fetch('/editor/api/files/custom.css', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: '' }) // Send empty content to clear the file
                    });
                    showNotification(response.ok ? 'custom.css cleared and editor reset.' : 'Failed to clear custom.css.', !response.ok);
                } catch (e) {
                    showNotification('Error clearing custom.css file.', true);
                }
            };

            const initializeEditor = () => {
                buildEditor();
                updatePreview();

                // Add event listeners after building the editor
                accordionContainer.addEventListener('input', (e) => {
                    const key = e.target.id.replace('control-', '').replace('-text', '');
                    const config = Object.values(editorConfig).flatMap(s => Object.entries(s)).find(([k,v]) => k === key)?.[1];
                    if (!config) return;

                    if (e.target.type === 'range') {
                        const display = e.target.nextElementSibling;
                        if (display) display.textContent = e.target.value + (config.unit || '');
                    } else if (e.target.type === 'color') {
                        const textInput = document.getElementById(e.target.id + '-text');
                        if (textInput) textInput.value = e.target.value;
                    } else if (e.target.type === 'text' && e.target.id.endsWith('-text')) {
                        const colorInput = document.getElementById(e.target.id.replace('-text', ''));
                        // Use a simple regex to check for a valid hex color format
                        if (colorInput && /^#([0-9A-F]{3}){1,2}$/i.test(e.target.value)) {
                            colorInput.value = e.target.value;
                        } else {
                            // Don't update preview if the hex is invalid to avoid errors
                            return;
                        }
                    }

                    handleInputChange();
                });

                // --- View Mode Toggle Logic ---
                viewToggleGroup.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const newView = e.target.dataset.view;
                        if (newView === currentViewMode) return;

                        currentViewMode = newView;
                        // Update active button style
                        viewToggleGroup.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        updatePreviewScaling();
                    }
                });

                // Accordion toggle logic
                accordionContainer.querySelectorAll('.accordion-header span').forEach(headerSpan => {
                    headerSpan.addEventListener('click', () => {
                        const content = headerSpan.parentElement.nextElementSibling;
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            // Close other open accordions
                            accordionContainer.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                });

                // Theme management event listeners
                saveThemeButton.addEventListener('click', handleSaveTheme);

                loadThemeButton.addEventListener('click', () => {
                    const name = themeSelector.value;
                    if (!name) {
                        showNotification('No theme selected to load.', true);
                        return;
                    }
                    const themes = getThemes();
                    if (themes[name]) {
                        applyTheme(themes[name]);
                    }
                });

                deleteThemeButton.addEventListener('click', () => {
                    const name = themeSelector.value;
                    if (!name) {
                        showNotification('No theme selected to delete.', true);
                        return;
                    }
                    deleteTheme(name);
                    populateThemeSelector();
                    showNotification(`Theme '${name}' deleted.`);
                });
            };

            // --- Pane Resizing Logic ---
            const editorPane = document.querySelector('.w-full.md\\:w-1\\/3');
            const previewPane = document.querySelector('.w-full.md\\:w-2\\/3');
            const resizeHandle = document.querySelector('.resize-handle');

            let isResizing = false;
            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const totalWidth = document.body.clientWidth;
                const newEditorWidth = Math.max(25, Math.min(75, (e.clientX / totalWidth) * 100));
                editorPane.style.width = `${newEditorWidth}%`;
                previewPane.style.width = `${100 - newEditorWidth}%`;
                updatePreviewScaling(); // Recalculate scale on resize
            });
            document.addEventListener('mouseup', () => {
                isResizing = false;
                updatePreviewScaling(); // Final scale calculation
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
            });

            // --- Event Listeners ---

            saveButton.addEventListener('click', async () => {
                // Before saving, collect the current values from all inputs to ensure we have the complete state.
                const cssToSave = generateCss();

                try {
                    const response = await fetch('/editor/api/files/custom.css', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: cssToSave })
                    });
                    const result = await response.json();
                    showNotification(result.message, !response.ok);
                } catch (e) {
                    showNotification('Error saving file.', true);
                }
            });

            resetButton.addEventListener('click', resetToDefaults);

            previewFrame.addEventListener('load', updatePreview);

            if (!homepageUrlInput.readOnly) {
                homepageUrlInput.addEventListener('change', () => {
                    const url = homepageUrlInput.value;
                    if (url) {
                        previewFrame.src = url;
                        localStorage.setItem('homepagePreviewUrl', url);
                    }
                });
            }

            // --- Initialization ---

            let initialUrl = homepageUrlInput.value;
            if (!initialUrl) {
                initialUrl = localStorage.getItem('homepagePreviewUrl') || '';
                homepageUrlInput.value = initialUrl;
            }
            if (initialUrl) {
                previewFrame.src = initialUrl;
            } else {
                console.warn("Homepage preview URL is not set. Preview will be blank.");
            }

            initializeEditor();
            populateThemeSelector();
            // Set initial scale and add a listener for window resize events
            updatePreviewScaling();
            window.addEventListener('resize', updatePreviewScaling);

            {% if not any_source_configured %}
            const fetchVersion = async () => {
                const versionDiv = document.getElementById('app-version');
                const versionDivMobile = document.getElementById('app-version-mobile');
                try {
                    const response = await fetch('/api/version');
                    const data = await response.json();
                    if (versionDiv) versionDiv.textContent = `v${data.version}`;
                    if (versionDivMobile) versionDivMobile.textContent = `v${data.version}`;
                } catch (e) {
                    if (versionDiv) versionDiv.textContent = 'v-unknown';
                }
            };
            fetchVersion();
            {% endif %}

            // Mobile menu toggle
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const svgs = mobileMenuButton.querySelectorAll('svg');

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                svgs[0].classList.toggle('hidden');
                svgs[1].classList.toggle('hidden');
            });
        });
    </script>
</body>

</html>